{% extends "./layout.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{% static 'css/legend.css' %}">


<main>

<!-- selection part  -->
<div style="display: flex; align-items: center; justify-content: center;">
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalLong" >
    Select Two courses
  </button>
  <p style="margin-bottom: 0; margin-left: 20px;" id="selected-course"> </p>
  <a href="#" id="nodes-pairs" style="color:dodgerblue; text-decoration: underline;"></a>
</div>



 <!-- select courses pop-up window  -->
 <div class="modal fade" id="ModalLong" tabindex="-1" role="dialog" aria-labelledby="ModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ModalLongTitle">Select Two courses</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <!-- get courses list -->
        <div style="padding-left: 25px">
          <h6>ACM courses:</h6>

        {% for courese in acm_courses %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="{{ courese.course_id }}" id="defaultCheck1">
          <label class="form-check-label" for="defaultCheck1">
            {{ courese.course_name }}
          </label>
        </div>
      {% endfor %}
        </div>
      </br> 

        <div style="padding-left: 25px">
          <h6>UvA courses:</h6>

        {% for courese in uva_courses %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="{{ courese.course_id }}" id="defaultCheck1">
          <label class="form-check-label" for="defaultCheck1">
            {{ courese.course_name }}
          </label>
        </div>
         {% endfor %}
        </div>
        <!-- end -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="add-button" >Detect similarity</button>
      </div>
    </div>
  </div>
</div> 



 <!-- similar nodes pop-up window  -->
<div class="modal fade bd-example-modal-lg" id="Modal-nodes-pairs" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ModalLongTitle">Similar nodes pairs</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
        <div class="modal-body-node-pair" style="max-height: 500px; overflow-y: auto;">
          <div style="padding-left: 25px;  padding-right: 25px; padding-top: 10px" id="nodes-pair-content">
            <ul class="list-group list-group-horizontal">
              <!-- Nodes pairs will be appended here -->
            </ul>
        </div>
        </div>
      </br>
      </div>
    </div>
</div>



<hr>
<!-- legend part  -->
<div id="legend-container">
    <!-- color legend -->
    <div class="legend-item">
        <div class="color-box" style="background-color: #b8bceb;"></div>
        <span>Create</span>
    </div>
    <div class="legend-item">
        <div class="color-box" style="background-color: #a3ddf5;"></div>
        <span>Evaluate</span>
    </div>
    <div class="legend-item">
        <div class="color-box" style="background-color: #b0e3bf;"></div>
        <span>Analyze</span>
    </div>
    <div class="legend-item">
        <div class="color-box" style="background-color: #FDDA0D;"></div>
        <span>Apply</span>
    </div>
    <div class="legend-item">
        <div class="color-box" style="background-color: #ffd2af;"></div>
        <span>Understand</span>
    </div>
    <div class="legend-item">
        <div class="color-box" style="background-color: #faadb0;"></div>
        <span>Remember</span>
    </div>

    <!-- shape legend -->
    <div class="legend-item">
        <div class="shape-box circle" ></div>
        <span>Course</span>
    </div>
    <div class="legend-item">
        <div class="shape-box oval"></div>
        <span>Knowledge Unit</span>
    </div>
    <div class="legend-item">
        <div class="shape-box round-rect"></div>
        <span>Knowledge Point / Sub Knowledge Point</span>
    </div>
</div>



 <!-- network part  -->
<div id="mynetwork" style="display: flex; align-items: center; justify-content: center;">
  <span id="usage-hint" style="color: rgb(147, 145, 145);">Please click the button and choose two courses to compare the similarty between them</span>
</div>

</main>






<script>
  var dataset_nodes; 
  var dataset_edges; 

  $(document).ready(function() {
    $("#add-button").click(function() {
      $("#usage-hint").hide(); //hide the hint text

      var checkboxes = $(".form-check-input:checked");
        if (checkboxes.length !== 2) {
            alert("Please select 2 courses.");
        } else {
            var selectedCourses = [];
            var selectedCoursesID = [];
            checkboxes.each(function() {
                selectedCourses.push($(this).siblings('label').text().trim());
                selectedCoursesID.push($(this).val());
            });
            // send the selected courses to the backend
            sendSelectedCourses(selectedCoursesID);

            // close the modal
            $("#ModalLong").modal("hide");

            // update the text of id="selected-course" 
            $("#selected-course").text("selected: " + selectedCourses.join(", ") + "");

            // Add click event for "nodes pair"
            $("#nodes-pairs").text("(check similar nodes pairs)");
            $("#nodes-pairs").click(function() {
                $("#Modal-nodes-pairs").modal("show");

                var modalBody = $("#nodes-pair-content .list-group");
                modalBody.empty(); 
                var count = 1;
                // filter the similar nodes pairs data
                dataset_edges.forEach(function(edge) {
                  if (edge.color === "grey") {
                            var fromNode = findNodeById(edge.from);
                            var toNode = findNodeById(edge.to);
                            if (fromNode && toNode) {
                                if (fromNode.cog_level !== toNode.cog_level) {
                                    modalBody.append("<li class='list-group-item list-group-item-primary'><span style='color: red;'>" + count+'.Cognitive level is not matched ' +  "</span></li>");
                                } else {
                                    modalBody.append("<li class='list-group-item list-group-item-primary'>" + count + '.Cognitive level is matched' +  "</li>");
                                }
                                modalBody.append("<li class='list-group-item '>" + "("+fromNode.cog_level+")"+ fromNode.description +  "</li>");
                                modalBody.append("<li class='list-group-item '>" + "("+toNode.cog_level+")"+ toNode.description + "</li>");
                                count++;
                            }
                        }
                });
            });
        }
    });
  });


  function findNodeById(nodeId) {
      return dataset_nodes.find(function(node) {
          return node.id === nodeId;
      });
  }
  
  
  function sendSelectedCourses(courses) {
  
      $.ajax({
  
          url: '{% url "similarity-detect" %}', 
          type: "POST",
          data:{
  
            courselist: JSON.stringify(courses), 
            csrfmiddlewaretoken: "{{csrf_token}}",
  
          },
          success: function(response) {
              if (response.nodes.length > 0) {
                dataset_nodes = response.nodes;
                dataset_edges = response.edges;
                displayGraph(response);
              } else {
                  alert("The selected courses don't have any similar nodes. Please select other courses!");
              }
          },
          error: function(xhr, status, error) {
          }
      });
  }

  

  function displayGraph(response) {

      var nodes = new vis.DataSet(response.nodes);
      var edges = new vis.DataSet(response.edges);
      

      color_mapping = {
            "create": "#b8bceb",      // purple
            "evaluate": "#a3ddf5",    // blue
            "analyze": "#b0e3bf",     // green
            "apply": "#fefaa3",       // yellow
            "understand": "#ffd2af",  // orange
            "remember": "#faadb0"     // red
        }

      nodes.forEach(function(node) {
          var cogLevel = node.cog_level.toLowerCase();
          if (node.shape !== 'circle' && color_mapping.hasOwnProperty(cogLevel)) {
              node.color = { background: color_mapping[cogLevel], border: color_mapping[cogLevel] };
          } else if (node.cog_level === ""){
              node.color = { background: "#D3D3D3", border: "#7D7C7C"};
          }
          
      });


      // Instantiate our network object.
      var container = document.getElementById("mynetwork");
      var data = {
        nodes: nodes,
        edges: edges,
      };

      
      var options = {
        nodes: {
          shape: "dot",
            borderWidth: 2,
            shadow: true,
            size: 15,
            color: {
              border: "#406897",
              background: "#6AAFFF",
            },
            font: { color: "black" },
            shapeProperties: {
              useBorderWithImage: true,
            },
            widthConstraint: {
            maximum: 200,
            },
          },

          edges: {
            width: 2,
            shadow: true,
          },

          interaction: {
            navigationButtons: true,
            keyboard: true,
          },

          physics: {
            barnesHut: { gravitationalConstant: -8000 },
            stabilization: { iterations: 6000 },
          },
      };
      network = new vis.Network(container, data, options);
  }
</script>






{% endblock %}